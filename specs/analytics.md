# Web Analytics Specification

## Overview

CoPI uses a self-hosted [Umami](https://umami.is) instance for privacy-friendly web analytics. Umami runs as an additional Docker Compose service alongside the existing stack, proxied through Nginx on the same domain to avoid ad blockers.

## Architecture

```
Browser ──→ Nginx (copi.science)
              ├── /            ──→ Next.js app (port 3000)
              ├── /_next/static/ ──→ Next.js app (cached)
              ├── /u/script.js ──→ Umami (port 3001)  ← tracking script
              └── /u/api/send  ──→ Umami (port 3001)  ← event collection
```

Umami shares the existing PostgreSQL instance via a dedicated `umami` database. This avoids running a second Postgres container while keeping analytics data isolated from the application database.

## Infrastructure

### Docker Compose Service

Add an `umami` service to `docker-compose.prod.yml`:

- **Image:** `ghcr.io/umami-software/umami:postgresql-latest`
- **Port:** 3001 (internal only, not exposed to host)
- **Database:** Separate `umami` database on the shared PostgreSQL instance
- **Depends on:** `postgres` (healthy)
- **Environment variables:**
  - `DATABASE_URL` — connection string pointing to the `umami` database
  - `TRACKER_SCRIPT_NAME` — rename from `script.js` to a generic name (e.g., `app.js`) for ad-blocker resistance
  - `COLLECT_API_ENDPOINT` — rename from `/api/send` to a generic name (e.g., `/api/t`) for ad-blocker resistance
  - `APP_SECRET` — random secret for session encryption (reuse or generate alongside existing secrets)
- **Logging:** CloudWatch (`/copi/umami`)

### PostgreSQL Setup

Add an init script to create the `umami` database on first boot:

- Mount `./scripts/init-umami-db.sh` into Postgres at `/docker-entrypoint-initdb.d/`
- Script contents: `CREATE DATABASE umami;`
- Only runs on initial volume creation (standard Postgres entrypoint behavior)
- Umami auto-creates its own schema tables on first startup

### Nginx Proxy

Add location blocks to the HTTPS server in `nginx/nginx.conf`:

```nginx
# Umami analytics — proxy tracking script and event collection
# through the main domain to avoid ad-blocker detection.
location /u/ {
    proxy_pass http://umami:3001/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### Environment Variables

Add to `.env` and `.env.example`:

```
# Umami Analytics
UMAMI_APP_SECRET=<random-secret>
```

The `UMAMI_WEBSITE_ID` is generated by Umami on first setup (via its admin UI) and then hardcoded in the Next.js layout. It is not sensitive — it's the same value that appears in the public tracking script tag.

## Frontend Integration

### Tracking Script

Add the Umami script tag to `src/app/layout.tsx` inside `<head>`:

```tsx
<Script
  src="/u/app.js"
  data-website-id={process.env.NEXT_PUBLIC_UMAMI_WEBSITE_ID}
  strategy="afterInteractive"
/>
```

- Uses Next.js `<Script>` component with `afterInteractive` strategy (does not block page load)
- Script is served from the same domain via the Nginx proxy, so it appears as a first-party resource
- Renamed script file (`app.js`) avoids common ad-blocker pattern matches

### Environment Variable

Add to `.env` and `.env.example`:

```
NEXT_PUBLIC_UMAMI_WEBSITE_ID=<from-umami-admin-ui>
```

This is a `NEXT_PUBLIC_` variable because it must be available in client-side code. The website ID is not sensitive (it appears in every page's HTML source).

## Custom Event Tracking

Track key user interactions beyond pageviews using Umami's `data-umami-event` HTML attributes or the `umami.track()` JavaScript API.

### Events to Track

| Event Name | Trigger | Properties |
|---|---|---|
| `swipe-interested` | User swipes "Interested" on a proposal | `proposalId` |
| `swipe-archive` | User swipes "Archive" on a proposal | `proposalId` |
| `expand-proposal` | User expands proposal detail card | `proposalId` |
| `match-view` | User views a match | `matchId` |
| `profile-edit` | User saves profile edits | — |
| `match-pool-add` | User adds someone to match pool | `method` (search, affiliation, all) |
| `survey-submit` | User submits archive survey | `reasons` (comma-separated) |

### Implementation Approach

Use `data-umami-event` attributes on existing interactive elements where possible (zero-JS approach). For events that fire programmatically (e.g., after an API call succeeds), use:

```typescript
// Only runs client-side; umami global is injected by the script
if (typeof umami !== 'undefined') {
  umami.track('swipe-interested', { proposalId: id });
}
```

Wrap in a small utility (`src/lib/analytics.ts`) to centralize the guard:

```typescript
export function trackEvent(name: string, data?: Record<string, string | number>) {
  if (typeof window !== 'undefined' && typeof umami !== 'undefined') {
    umami.track(name, data);
  }
}
```

## Initial Setup (Post-Deploy)

After the first deployment with Umami running:

1. Access Umami admin UI at `https://copi.science/u/` (default credentials: `admin` / `umami`)
2. **Change the default admin password immediately**
3. Add `copi.science` as a website in the Umami dashboard
4. Copy the generated Website ID
5. Set `NEXT_PUBLIC_UMAMI_WEBSITE_ID=<id>` in `.env` and redeploy the `app` service

## Privacy

- **No cookies** — Umami is cookieless by design
- **No PII** — IP addresses are never stored; unique visitors identified by a rotating hash
- **No consent banner needed** — GDPR/CCPA compliant without opt-in
- **Data stays on our server** — self-hosted, no third-party data sharing
- **Same-domain proxying** — tracking requests are indistinguishable from application requests

## Development

For local development, Umami is **not included** in the dev `docker-compose.yml`. The tracking script simply won't load (no `/u/app.js` endpoint), and `trackEvent()` calls silently no-op due to the `typeof umami` guard. No conditional logic or environment checks needed.

## Out of Scope

- Funnels, retention, and journey reports — available in Umami but configured via the Umami UI, not in application code
- User identification (`umami.identify()`) — not needed; CoPI analytics are aggregate, not per-user
- Pixel tracking / email open tracking
- A/B testing
